<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>島ぬひみつきち</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src='https://unpkg.com/react-router-dom@5.0.0/umd/react-router-dom.min.js' crossorigin></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
  const { useState, useEffect } = React;
  const { HashRouter, Route, withRouter } = ReactRouterDOM;

  const Home = withRouter(({ history, location }) => {
      const [posts, setPosts] = useState([]);
      const [searchParams, setSearchParams] = useState({
          category: '',
          keyword: '',
          region: ''
      });
      const [showResults, setShowResults] = useState(false);

      useEffect(() => {
          const params = new URLSearchParams(location.search);
          setSearchParams({
              category: params.get('category') || '',
              keyword: params.get('keyword') || '',
              region: params.get('region') || ''
          });
          setShowResults(location.search !== '');

      }, [location.search]);

      const handleRegionClick = (regionName) => {
          setSearchParams(prev => ({ ...prev, region: regionName }));
      };
      /*
      const handleSearchClick = () => {
          const { category, keyword, region } = searchParams;
          history.push(`/?category=${category}&keyword=${keyword}&region=${region}`);
          setShowResults(true);
      };
      */
      const handleInputChange = (e) => {
            const { name, value } = e.target;
            setSearchParams(prev => ({ ...prev, [name]: value }));
        };

      useEffect(() => {
        const { category, keyword, region } = searchParams;
        history.push(`/?category=${category}&keyword=${keyword}&region=${region}`);
        setShowResults(true);
        const fetchPosts = async () => {
            const { category, keyword, region } = searchParams;
            try {
                const response = await axios.get('/api/search', {
                    params: {
                        category,
                        keyword,
                        region
                    }
                });
                setPosts(response.data);
            } catch (error) {
                console.error('Error fetching posts:', error);
                // エラーハンドリングを行う（例：エラーメッセージの表示）
            }
      };
          fetchPosts();
      }, [searchParams, showResults]);

      return (
          <div>
              <h1>島ぬひみつきち</h1>
              <div>
                  <input
                      type="text"
                      name="category"
                      value={searchParams.category}
                      onChange={handleInputChange}
                      placeholder="カテゴリー"
                  />
                  <input
                      type="text"
                      name="keyword"
                      value={searchParams.keyword}
                      onChange={handleInputChange}
                      placeholder="キーワード"
                  />
                  <input
                      type="text"
                      name="region"
                      value={searchParams.region}
                      readOnly
                      placeholder="地域"
                  />

              </div>
              <div>
                  <button onClick={handleRegionClick.bind(null, '那覇')}>那覇</button>
                  <button onClick={handleRegionClick.bind(null, '沖縄市')}>沖縄市</button>
                  <button onClick={handleRegionClick.bind(null, '浦添')}>浦添</button>
                  {/* 他の地域ボタンも同様に */}
              </div>

            <div>
                {posts.map(post => (
                    <div className="post">
                            <label for="postdata"></label>
                        <img src='../img/青りんご海.jpg' name="postdata" alt="post" />
                        <div>
                            <span name="postdata">

                                <h1>{post.title}</h1>
                                <p>{post.summary}</p>
                            </span>
                            <br />
                            <span name="postdata">
                                <span>{post.categories.name}</span>
                                <span>{post.users.username}</span>
                            </span>

                        </div>

                    </div>
                ))}
        </div>

          </div>
      );
  });

  const App = () => {
      return (
          <HashRouter>
              <Route path="/" component={Home} />
          </HashRouter>
      );
  };

  ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>